<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swasthmate - MedAssist</title>
        <!-- Import Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <!-- Import Material Icons -->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/legacy.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
       <style>
    :root {
      --primary-blue: #0066cc;
      --secondary-blue: #4a90e2;
      --accent-blue: #e3f2fd;
      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --error-red: #ef4444;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --border-color: #e2e8f0;
      --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.06);
      --shadow-heavy: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
    }

    /* Hero Section for MedAssist */
    .hero-section-medassist {
        background: linear-gradient(to bottom right, #eff6ff, #dbeafe, #bfdbfe);
        color: #1e293b;
        padding: 4rem 1rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .container-hero-medassist {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .medical-icons-row-medassist {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .med-icon-pulse-medassist {
        font-size: 3rem;
        opacity: 0.8;
        animation: pulse-medassist 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-medassist {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 0.5; }
    }

    .assistant-icon-wrapper {
        margin-bottom: 1.5rem;
    }

    .assistant-icon-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 5rem;
        height: 5rem;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        border-radius: 9999px;
        margin-bottom: 1rem;
    }

    .assistant-icon {
        font-size: 2.5rem;
    }

    .hero-title-medassist {
        color: #1e293b;
        margin-bottom: 1rem;
    }

    .hero-title-medassist .font-bold {
        font-weight: 700;
        font-size: 1.5rem;
    }

    .hero-subtitle-medassist {
        color: #475569;
        max-width: 42rem;
        margin: 0 auto;
        font-size: 1.125rem;
    }

    /* Features Section */
    .features-section-medassist {
        margin-top: 4rem;
        padding: 3rem 1rem;
        background: var(--bg-secondary);
    }

    .container-features-medassist {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .features-grid-medassist {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        max-width: 80rem;
        margin: 0 auto;
    }

    .feature-card-medassist {
        text-align: center;
        padding: 1.5rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: var(--shadow-light);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: default;
        pointer-events: auto;
        position: relative;
        z-index: 1;
    }

    .feature-card-medassist:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .feature-icon-circle-medassist {
        background: #dbeafe;
        width: 4rem;
        height: 4rem;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }

    .feature-icon-medassist {
        font-size: 1.5rem;
    }

    .feature-title-medassist {
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-weight: 700;
        font-size: 1.25rem;
    }

    .feature-description-medassist {
        color: #4b5563;
        line-height: 1.6;
    }

    /* Disclaimer Section */
    .disclaimer-section-medassist {
        margin-top: 3rem;
        padding: 2rem 1rem;
    }

    .container-disclaimer-medassist {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .disclaimer-box-medassist {
        padding: 1.5rem;
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 0.75rem;
        max-width: 80rem;
        margin: 0 auto;
    }

    .disclaimer-text-medassist {
        color: #78350f;
        text-align: center;
        line-height: 1.6;
    }

    .disclaimer-icon-medassist {
        margin-right: 0.5rem;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        .hero-section-medassist {
            padding: 2rem 1rem;
            margin-bottom: 1rem;
        }

        .medical-icons-row-medassist {
            gap: 1rem;
        }

        .med-icon-pulse-medassist {
            font-size: 2rem;
        }

        .assistant-icon-circle {
            width: 4rem;
            height: 4rem;
        }

        .assistant-icon {
            font-size: 2rem;
        }

        .hero-title-medassist .font-bold {
            font-size: 1.25rem;
        }

        .hero-subtitle-medassist {
            font-size: 1rem;
        }

        .features-grid-medassist {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .disclaimer-box-medassist {
            padding: 1rem;
        }

        .disclaimer-text-medassist {
            font-size: 0.875rem;
        }
    }

    .dark-theme {
      --primary-blue: #3b82f6;
      --secondary-blue: #60a5fa;
      --accent-blue: #1e3a8a;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --border-color: #334155;
      --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.6);
      --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
      --shadow-heavy: 0 20px 25px rgba(0, 0, 0, 0.4), 0 10px 10px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-x: hidden;
    }

    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      margin-top: -2rem;
    }

    .app-container::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-light);
    }

    .dark-theme header {
      background: rgba(15, 23, 42, 0.95);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

   

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.025em;
    }

    .logo-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 900;
      margin-right: 700px;
    }

    .header-controls {
      display: flex;
      align-items: left;
      gap: 1.5rem;
    }

    .control-panel {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1.25rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-light);
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .custom-select {
      position: relative;
      min-width: 120px;
    }

    .custom-select select {
      width: 100%;
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      appearance: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .custom-select select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .custom-select::after {
      content: '‚ñº';
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 0.75rem;
      pointer-events: none;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-medium);
    }

    .theme-toggle:hover {
      background: var(--secondary-blue);
      transform: translateY(-1px);
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .chat-workspace {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 2rem;
      align-items: start;
      min-height: calc(100vh - 300px);
      max-height: calc(100vh - 200px);
    }

    .chat-main {
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      border-radius: 20px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-heavy);
      min-height: 600px;
      max-height: calc(100vh - 200px);
      overflow: hidden;
      position: relative;
      height: 100%;
    }

    .chat-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--accent-blue), rgba(255, 255, 255, 0.8));
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dark-theme .chat-header {
      background: linear-gradient(135deg, var(--accent-blue), rgba(30, 58, 138, 0.3));
    }

    .chat-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .status-online {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-green);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-listening {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-orange);
      border: 1px solid rgba(245, 158, 11, 0.2);
      animation: pulse 2s infinite;
    }

    .status-processing {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      scroll-behavior: smooth;
      background: linear-gradient(to bottom, rgba(249, 250, 251, 0.5), transparent);
    }

    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    .message {
      margin-bottom: 1.5rem;
      animation: messageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-user {
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      gap: 0.75rem;
    }

    .message-assistant {
      display: flex;
      justify-content: flex-start;
      align-items: flex-end;
      gap: 0.75rem;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .avatar-user {
      background: var(--primary-blue);
      color: white;
    }

    .avatar-assistant {
      background: var(--success-green);
      color: white;
    }

    .message-content {
      max-width: 70%;
      padding: 1rem 1.25rem;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
    }

    .message-user .message-content {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: var(--shadow-medium);
    }

    .message-assistant .message-content {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 4px;
      box-shadow: var(--shadow-light);
      position: relative;
    }

    .message-assistant .message-content::before {
      content: '';
      position: absolute;
      left: -1px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--success-green);
      border-radius: 2px 0 0 2px;
    }

    .message-timestamp {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      text-align: center;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      max-width: 70px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typingDot 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typingDot {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Chat Input Area */
    .chat-input-area {
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
      background: var(--bg-primary);
      border-radius: 0 0 20px 20px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 28px;
      padding: 0.75rem 1.25rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .input-wrapper:focus-within {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }

    .chat-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 1rem;
      padding: 0.5rem 0;
      outline: none;
      resize: none;
      font-weight: 400;
    }

    .chat-input::placeholder {
      color: var(--text-secondary);
    }

    .send-btn, .voice-toggle-btn {
      display: flex !important;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 24px;
      background: var(--primary-blue);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      visibility: visible !important;
      opacity: 1 !important;
      font-weight: 600;
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .send-btn:hover, .voice-toggle-btn:hover {
      background: var(--secondary-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .send-btn:active, .voice-toggle-btn:active {
      transform: translateY(0);
    }

    .send-btn svg, .voice-toggle-btn svg {
      width: 20px;
      height: 20px;
      stroke-width: 2.5;
      flex-shrink: 0;
    }

    .btn-label {
      font-size: 0.875rem;
      font-weight: 600;
      letter-spacing: 0.025em;
    }

    .voice-toggle-btn {
      background: var(--success-green);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .voice-toggle-btn:hover {
      background: #059669;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .voice-toggle-btn.active {
      background: var(--error-red);
      animation: pulse-voice 2s infinite;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .voice-toggle-btn.active:hover {
      background: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .send-btn {
      background: var(--primary-blue);
    }

    @keyframes pulse-voice {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }
      50% {
        box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
      }
    }

    .input-hints {
      margin-top: 0.5rem;
      text-align: center;
    }

    .hint-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Language Selector */
    .language-selector {
      margin-top: 0.5rem;
    }

    .language-select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .language-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .sidebar {
      background: var(--bg-primary);
      border-radius: 20px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-heavy);
      overflow-y: auto;
      height: 100%;
      max-height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
      align-self: start;
    }


    .sidebar-section {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-section:last-child {
      border-bottom: none;
    }

    .sidebar-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    .voice-controls {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .voice-btn {
      display: flex !important;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      visibility: visible !important;
      opacity: 1 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background: var(--primary-blue);
      color: white;
      box-shadow: var(--shadow-medium);
    }

    .btn-primary:hover {
      background: var(--secondary-blue);
      transform: translateY(-1px);
      box-shadow: var(--shadow-heavy);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--accent-blue);
      border-color: var(--primary-blue);
    }

    .btn-success {
      background: var(--success-green);
      color: white;
      box-shadow: var(--shadow-medium);
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    .btn-listening {
      background: var(--warning-orange);
      color: white;
      animation: pulse 2s infinite;
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .stat-card {
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-blue);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .quick-action {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }

    .quick-action:hover {
      background: var(--accent-blue);
      border-color: var(--primary-blue);
    }

    .quick-action-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
    }

    .floating-panel {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 400px;
      max-height: 300px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow-heavy);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .floating-panel.show {
      transform: translateY(0);
      opacity: 1;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .panel-close {
      width: 24px;
      height: 24px;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .panel-close:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .panel-content {
      padding: 1rem;
      overflow-y: auto;
      max-height: 200px;
    }

    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }


    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typingDot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingDot {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    @media (max-width: 1024px) {
      .chat-workspace {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .sidebar {
        order: -1;
      }
      
      .floating-panel {
        width: calc(100vw - 2rem);
        right: 1rem;
        left: 1rem;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      
      .header-controls {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .control-panel {
        flex-direction: column;
        align-items: stretch;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      .chat-workspace {
        height: auto;
        min-height: calc(100vh - 200px);
      }
    }
  </style>
</head>
<body class="light-theme" style="padding-top: 64px;">
    <!-- Header -->
    <header class="header-modern">
        <div class="container-modern">
            <div class="navbar-modern">
                <!-- Logo -->
                <div class="logo-modern">
                    <div class="logo-icon-modern">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="Swasthmate Logo">
                    </div>
                    <span class="logo-text-modern">Swasth<span class="mate-part">mate</span></span>
                </div>

                <!-- Desktop Navigation -->
                <nav class="nav-modern" aria-label="Main navigation">
                    <a href="/" class="nav-link-modern">Home</a>
                    <a href="/upload" class="nav-link-modern">Prescription Reader</a>
                    <a href="/MedAssist" class="nav-link-modern">MedAssist</a>
                    <a href="/about" class="nav-link-modern" onclick="globalThis.location.href='/about'; return true;">About Us</a>
                    <a href="/contact" class="nav-link-modern" onclick="globalThis.location.href='/contact'; return true;">Contact</a>
                </nav>

                <!-- Right Side Actions -->
                <div class="header-actions-modern">
                    <div id="loginButtonContainer">
                        <a href="/login" class="login-btn-modern">Log In / Sign up</a>
                    </div>
                    <div id="profileButtonContainer" class="profile-container-modern" style="display: none;">
                        <button class="user-icon-btn" onclick="toggleProfileDropdown()">
                            <i class="fas fa-user"></i>
                        </button>
                        <div class="profile-dropdown-modern" id="profileDropdownModern">
                            <div class="profile-header-modern">
                                <div class="profile-info-modern">
                                    <div class="profile-avatar-modern" id="profileAvatarModern">U</div>
                                    <div class="profile-details-modern">
                                        <h3 id="dropdown-user-name-modern">User</h3>
                                        <p id="dropdown-user-email-modern">user@example.com</p>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-menu-modern">
                                <button type="button" class="profile-menu-item-modern" onclick="editProfile(); return false;" aria-label="Edit profile">
                                    <i class="fas fa-edit"></i>
                                    Edit Profile
                                </a>
                                <button class="profile-menu-item-modern logout-modern" onclick="handleLogout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
                
            <!-- Mobile Menu -->
            <div class="mobile-menu" id="mobileMenu">
                <nav class="mobile-nav" aria-label="Mobile navigation">
                    <a href="/" class="mobile-nav-link" onclick="globalThis.location.href='/'; return true;">Home</a>
                    <a href="/upload" class="mobile-nav-link" onclick="globalThis.location.href='/upload'; return true;">Prescription Reader</a>
                    <a href="/MedAssist" class="mobile-nav-link" onclick="globalThis.location.href='/MedAssist'; return true;">MedAssist</a>
                    <a href="/about" class="mobile-nav-link" onclick="globalThis.location.href='/about'; return true;">About Us</a>
                    <a href="/contact" class="mobile-nav-link" onclick="globalThis.location.href='/contact'; return true;">Contact</a>
                </nav>
            </div>
        </div>
    </header>
    

    <!-- Profile Modal -->
    <section id="profile-view" style="display: none;">
        <div class="profile-modal">
            <button class="close-profile" onclick="closeProfile()">&times;</button>
            <h2>My Profile</h2>
           <form id="edit-profile-form">
      <p><strong>Name:</strong> <input type="text" id="edit-name" required></p>
      <p><strong>Email:</strong> <input type="email" id="edit-email" required></p>
      <p><strong>Password:</strong> <input type="password" id="edit-password" required></p>
      <button type="submit" class="demo-button">Save Changes</button>
    </form>
            
    </section>
    <!-- Hero Section -->
    <div class="hero-section-medassist">
        <div class="container-hero-medassist">
            <!-- Medical Icons -->
            <div class="medical-icons-row-medassist">
                <span class="med-icon-pulse-medassist" style="animation-delay: 0s;">ü§ñ</span>
                <span class="med-icon-pulse-medassist" style="animation-delay: 0.2s;">üí¨</span>
                <span class="med-icon-pulse-medassist" style="animation-delay: 0.4s;">‚öïÔ∏è</span>
            </div>

            <!-- Assistant Icon -->
            <div class="assistant-icon-wrapper">
                <div class="assistant-icon-circle">
                    <span class="assistant-icon">ü§ñ</span>
                </div>
            </div>

            <!-- Title -->
            <h1 class="hero-title-medassist">
                <span class="font-bold">MedAssist Pro</span>
            </h1>

            <!-- Subtitle -->
            <p class="hero-subtitle-medassist">
                AI-Powered Medical Assistant - Get instant health information and guidance
            </p>
        </div>
    </div>

  <div class="app-container">
   
      <div class="header-content">
        <div class="logo-section">
        </div>
        
        <div class="header-controls">
          <div class="control-panel">
            <div class="control-item">
              <span class="control-label">Language:</span>
              <div class="custom-select">
                <select id="languageSelect">
                  <option value="en-US">English (US)</option>
                  <option value="en-GB">English (UK)</option>
                  <option value="es-ES">Espa√±ol</option>
                  <option value="fr-FR">Fran√ßais</option>
                  <option value="de-DE">Deutsch</option>
                  <option value="it-IT">Italiano</option>
                  <option value="pt-PT">Portugu√™s</option>
                  <option value="ja-JP">Êó•Êú¨Ë™û</option>
                  <option value="ko-KR">ÌïúÍµ≠Ïñ¥</option>
                  <option value="zh-CN">‰∏≠Êñá</option>
                  <option value="hi-IN">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                  <option value="ar-SA">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
              </div>
            </div>
          </div>
          
          <button class="theme-toggle" id="themeToggle">
            <span id="themeIcon">üåô</span>
            <span id="themeText">Dark Mode</span>
          </button>
        </div>
      </div>


    <div class="main-content">
      <div class="chat-workspace">
        <div class="chat-main">
          <div class="chat-header">
            <div class="chat-title">Medical Consultation</div>
            <div class="status-badge status-online" id="statusBadge">
              <div class="status-indicator"></div>
              <span>Online</span>
            </div>
          </div>
          
          <div class="messages-container" id="messagesContainer">
            <div class="message">
              <div class="message-assistant">
                <div class="message-avatar avatar-assistant">ü§ñ</div>
                <div class="message-content">
                  Welcome to MedAssist Pro! I'm your AI-powered medical assistant. I can help you with health information, symptom guidance, medication questions, and general medical inquiries. 
                  <br><br>
                  <strong>Please note:</strong> I provide general information only and cannot replace professional medical advice. For emergencies, contact emergency services immediately.
                  <br><br>
                  Click the microphone to start our conversation, type your message below, or use the quick actions in the sidebar.
                </div>
              </div>
              <div class="message-timestamp">Just now</div>
            </div>
          </div>

          <!-- Typing Indicator -->
          <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="message-assistant">
              <div class="message-avatar avatar-assistant">ü§ñ</div>
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>

          <!-- Chat Input Area -->
          <div class="chat-input-area">
            <div class="input-wrapper">
              <input 
                type="text" 
                id="textInput" 
                class="chat-input" 
                placeholder="Type your message here..."
                autocomplete="off"
              />
              <button class="send-btn" id="sendBtn" title="Send message">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                <span class="btn-label">Send</span>
              </button>
            </div>
            <div class="input-hints">
              <span class="hint-text">Press Enter to send ‚Ä¢ Use sidebar microphone for voice input</span>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="sidebar-section">
            <div class="sidebar-title">Voice Controls</div>
            <div class="voice-controls">
              <button class="voice-btn btn-primary" id="voiceBtn">
                <span id="voiceIcon">üé§</span>
                <span id="voiceText">Start Speaking</span>
              </button>
              <button class="voice-btn btn-secondary" id="stopBtn" style="display: none;">
                <span>‚èπÔ∏è</span>
                <span>Stop Recording</span>
              </button>
              <button class="voice-btn btn-secondary" id="pauseBtn">
              ‚è∏Ô∏è Pause
            </button>
            <button class="voice-btn btn-success" id="resumeBtn">
              ‚ñ∂Ô∏è Resume
            </button>

            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">Session Stats</div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="messageCount">0</div>
                <div class="stat-label">Messages</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="sessionTime">0:00</div>
                <div class="stat-label">Duration</div>
              </div>
            </div>
          </div>
          
          <div class="sidebar-section">
            <div class="sidebar-title">Language Settings</div>
            <div class="language-selector">
              <select id="language" class="language-select">
                <option value="en-US" selected>English</option>
                <option value="hi-IN">Hindi</option>
                <option value="es-ES">Spanish</option>
                <option value="fr-FR">French</option>
              </select>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="floating-panel" id="summaryPanel">
      <div class="panel-header">
        <div class="panel-title">Conversation Summary</div>
        <button class="panel-close" id="closeSummary">‚úï</button>
      </div>
      <div class="panel-content" id="summaryContent"></div>
      </div>
    </div>

    <!-- Features Section -->
    <div class="features-section-medassist">
        <div class="container-features-medassist">
            <div class="features-grid-medassist">
                <div class="feature-card-medassist">
                    <div class="feature-icon-circle-medassist">
                        <span class="feature-icon-medassist">üí¨</span>
                    </div>
                    <h3 class="feature-title-medassist">AI-Powered Conversations</h3>
                    <p class="feature-description-medassist">
                        Natural language processing for intelligent medical conversations and instant responses
                    </p>
                </div>
                <div class="feature-card-medassist">
                    <div class="feature-icon-circle-medassist">
                        <span class="feature-icon-medassist">üé§</span>
                    </div>
                    <h3 class="feature-title-medassist">Voice Interaction</h3>
                    <p class="feature-description-medassist">
                        Speak naturally and get real-time medical guidance through voice commands
                    </p>
                </div>
                <div class="feature-card-medassist">
                    <div class="feature-icon-circle-medassist">
                        <span class="feature-icon-medassist">üåê</span>
                    </div>
                    <h3 class="feature-title-medassist">Multi-Language Support</h3>
                    <p class="feature-description-medassist">
                        Available in multiple languages for global accessibility and better user experience
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer-section-medassist">
        <div class="container-disclaimer-medassist">
            <div class="disclaimer-box-medassist">
                <p class="disclaimer-text-medassist">
                    <span class="disclaimer-icon-medassist">‚ö†Ô∏è</span>
                    <strong>Medical Disclaimer:</strong> This tool is for informational purposes only and should not replace professional medical advice. Always consult with your healthcare provider or pharmacist for medical advice and prescription verification. For emergencies, contact emergency services immediately.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer-modern">
        <div class="container-modern">
            <div class="footer-grid-modern">
                <!-- Brand -->
                <div class="footer-brand">
                    <div class="footer-logo-modern">
                        <div class="logo-icon-modern">
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="Swasthmate Logo">
                        </div>
                        <span class="logo-text-modern">Swasth<span class="mate-part">mate</span></span>
                    </div>
                    <p class="footer-description-modern">
                        AI-powered medical report analysis for better health insights.
                    </p>
                    <div class="social-links-modern">
                        <a href="#" class="social-link-modern"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link-modern"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link-modern"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" class="social-link-modern"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul class="footer-links-modern">
                        <li><a href="/">Home</a></li>
                        <li><a href="/upload">Prescription Reader</a></li>
                        <li><a href="/MedAssist">MedAssist</a></li>
                        <li><a href="/about">About Us</a></li>
                    </ul>
                </div>
                
                <!-- Services -->
                <div class="footer-column">
                    <h4>Services</h4>
                    <ul class="footer-links-modern">
                        <li><a href="/upload">Prescription Reader</a></li>
                        <li><a href="/MedAssist">MedAssist</a></li>
                        <li><a href="/">Report Analysis</a></li>
                        <li><a href="/contact">Contact</a></li>
                    </ul>
                </div>
                
                <!-- Contact -->
                <div class="footer-column">
                    <h4>Contact Us</h4>
                    <ul class="footer-contact-modern">
                        <li>
                            <i class="fas fa-envelope"></i>
                            <span>support@medscan.ai</span>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <span>+91-9005529331</span>
                        </li>
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span>India</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Bottom Bar -->
            <div class="footer-bottom-modern">
                <p>¬© 2025 Swasthmate. All rights reserved.</p>
                <div class="footer-legal-links-modern">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>
    <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
    <script>
        // Check if user is logged in
        function checkLoginStatus() {
            const userData = localStorage.getItem('userData');
            const loginContainer = document.getElementById('loginButtonContainer');
            const profileContainer = document.getElementById('profileButtonContainer');
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.loggedIn) {
                        if (loginContainer) loginContainer.style.display = 'none';
                        if (profileContainer) {
                            profileContainer.style.display = 'flex';
                            profileContainer.style.alignItems = 'center';
                        }
                        
                        const avatar = document.getElementById('profileAvatarModern');
                        const nameEl = document.getElementById('dropdown-user-name-modern');
                        const emailEl = document.getElementById('dropdown-user-email-modern');
                        
                        if (avatar) avatar.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                        if (nameEl) nameEl.textContent = user.name || 'User';
                        if (emailEl) emailEl.textContent = user.email || 'user@example.com';
                    } else {
                        if (loginContainer) loginContainer.style.display = 'block';
                        if (profileContainer) profileContainer.style.display = 'none';
                    }
                } catch (e) {
                    console.error('Error checking login status:', e);
                    if (loginContainer) loginContainer.style.display = 'block';
                    if (profileContainer) profileContainer.style.display = 'none';
                }
            } else {
                if (loginContainer) loginContainer.style.display = 'block';
                if (profileContainer) profileContainer.style.display = 'none';
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdownModern');
            if (dropdown) dropdown.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            const profileContainer = document.getElementById('profileButtonContainer');
            const dropdown = document.getElementById('profileDropdownModern');
            if (profileContainer && dropdown && !profileContainer.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function handleLogout() {
            localStorage.removeItem('userData');
            globalThis.location.href = '/';
        }

        function editProfile() {
            const userData = localStorage.getItem('userData');
            const profileView = document.getElementById('profile-view');
            const dropdown = document.getElementById('profileDropdownModern');
            
            if (dropdown) dropdown.classList.remove('active');
            
            if (userData) {
                const user = JSON.parse(userData);
                const nameInput = document.getElementById('edit-name');
                const emailInput = document.getElementById('edit-email');
                const passwordInput = document.getElementById('edit-password');
                
                if (nameInput) nameInput.value = user.name || '';
                if (emailInput) emailInput.value = user.email || '';
                if (passwordInput) passwordInput.value = user.password || '';
            }
            
            if (profileView) {
                profileView.style.display = 'flex';
                profileView.classList.add('active');
            }
        }

        function closeProfile() {
            const profileView = document.getElementById('profile-view');
            if (profileView) {
                profileView.style.display = 'none';
                profileView.classList.remove('active');
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu) menu.classList.toggle('active');
        }

        const editProfileForm = document.getElementById('edit-profile-form');
        if (editProfileForm) {
            editProfileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('edit-name').value;
                const email = document.getElementById('edit-email').value;
                const password = document.getElementById('edit-password').value;
                
                if (!name || !email) {
                    alert('Please fill in name and email');
                    return;
                }
                
                const userData = localStorage.getItem('userData');
                const existingUser = userData ? JSON.parse(userData) : {};
                
                const updatedUser = {
                    name: name,
                    email: email,
                    password: password || existingUser.password || '',
                    loggedIn: true
                };
                
                localStorage.setItem('userData', JSON.stringify(updatedUser));
                checkLoginStatus();
                closeProfile();
                alert('Profile updated successfully!');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
  <script>
class MedAssistPro {
  constructor() {
    this.messagesContainer = document.getElementById('messagesContainer');
    this.voiceBtn = document.getElementById('voiceBtn');
    this.stopBtn = document.getElementById('stopBtn');
    this.statusBadge = document.getElementById('statusBadge');
    this.textInput = document.getElementById('textInput');
    this.sendBtn = document.getElementById('sendBtn');
    // Voice toggle button removed from typing area - using sidebar voice button only
    this.typingIndicator = document.getElementById('typingIndicator');
    this.languageSelect = document.getElementById('language');
    this.messageCount = document.getElementById('messageCount');
    this.sessionTime = document.getElementById('sessionTime');
    this.summaryContent = document.getElementById('summaryContent');
    this.themeToggle = document.getElementById('themeToggle');

    this.conversationHistory = [];
    this.currentLanguage = 'en-US';
    this.isListening = false;
    this.sessionStartTime = Date.now();
    this.messageCounter = 0;

    this.initializeSpeechRecognition();
    this.bindEvents();
    this.startSessionTimer();
    this.loadWelcome();
  }

  initializeSpeechRecognition() {
    const SpeechRecognition = globalThis.SpeechRecognition || globalThis.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      console.error("Speech recognition not supported in this browser!");
      if (this.voiceBtn) {
        this.voiceBtn.disabled = true;
        this.voiceBtn.title = "Speech recognition not supported";
      }
      this.addAssistantMessage("‚ùó Voice recognition is not supported in your browser. Please use text input.");
      return;
    }

    try {
      this.recognition = new SpeechRecognition();
      // Get language from select element
      const langSelect = document.getElementById('language');
      this.currentLanguage = langSelect ? langSelect.value : 'en-US';
      this.recognition.lang = this.currentLanguage;
      this.recognition.continuous = true; // Set to true to keep listening
      this.recognition.interimResults = true; // Enable interim results for better UX
      this.recognition.maxAlternatives = 1;
      
      // Store accumulated transcript
      this.accumulatedTranscript = '';

      this.recognition.onstart = () => {
        console.log("Speech recognition started");
        this.accumulatedTranscript = ''; // Reset on start
        this.updateListening(true);
        if (this.statusBadge) {
          this.statusBadge.innerHTML = `<div class="status-indicator"></div><span>üé§ Listening...</span>`;
        }
      };
      
      this.recognition.onresult = (event) => {
        console.log("Speech recognition result:", event);
        
        // Get the final transcript
        let finalTranscript = '';
        let interimTranscript = '';
        
        // Process all results from the last resultIndex
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          const transcript = result[0].transcript;
          
          if (result.isFinal) {
            finalTranscript += transcript + ' ';
            // Clear accumulated transcript when we get a final result
            this.accumulatedTranscript = '';
          } else {
            interimTranscript += transcript;
          }
        }
        
        // Process final results immediately
        if (finalTranscript.trim()) {
          console.log("Final transcript:", finalTranscript.trim());
          this.handleTranscript(finalTranscript.trim());
        }
        
        // Show interim results in console for debugging
        if (interimTranscript) {
          console.log("Interim transcript:", interimTranscript);
        }
      };
      
      this.recognition.onend = () => {
        console.log("Speech recognition ended");
        
        // Check if we should continue listening BEFORE updating state
        const shouldContinue = this.isListening;
        
        // Don't update UI state here - keep it as listening if we're going to restart
        // Only update if we're actually stopping
        if (!shouldContinue) {
          this.updateListening(false);
        }
        
        // Auto-restart if user is still in listening mode (button is active)
        // This allows continuous listening until user manually stops
        if (shouldContinue && this.recognition) {
          try {
            // Use a longer delay to avoid restart conflicts
            setTimeout(() => {
              // Double-check that user still wants to listen
              if (this.isListening && this.recognition) {
                console.log("Auto-restarting speech recognition...");
                try {
                  this.recognition.start();
                } catch (startError) {
                  // If start fails (e.g., already started), wait a bit more
                  if (startError.name === 'InvalidStateError') {
                    console.log("Recognition already started, waiting...");
                    setTimeout(() => {
                      if (this.isListening && this.recognition) {
                        try {
                          this.recognition.start();
                        } catch (e) {
                          console.error("Failed to restart recognition:", e);
                          this.updateListening(false);
                        }
                      }
                    }, 500);
                  } else {
                    console.error("Failed to restart recognition:", startError);
                    this.updateListening(false);
                  }
                }
              }
            }, 100);
          } catch (e) {
            console.log("Recognition restart error:", e.message);
            // If restart fails, ensure state is correct
            this.updateListening(false);
          }
        } else {
          // Not continuing, so update UI
          this.updateListening(false);
        }
      };
      
      this.recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        
        // Don't show 'no-speech' error - it's normal if user doesn't speak immediately
        if (event.error === 'no-speech') {
          console.log("No speech detected - this is normal, continuing to listen...");
          // Don't update listening state or show error for no-speech
          // The recognition will auto-restart via onend handler
          return;
        }
        
        // For 'aborted' error, don't show error message (user stopped it)
        if (event.error === 'aborted') {
          console.log("Recognition aborted by user");
          return;
        }
        
        // For other errors, check if we should continue
        // Only stop if it's a critical error
        const criticalErrors = ['not-allowed', 'audio-capture'];
        if (criticalErrors.includes(event.error)) {
          this.updateListening(false);
        }
        
        let errorMessage;
        switch(event.error) {
          case 'audio-capture':
            errorMessage = "‚ùó Microphone not found. Please check your microphone.";
            break;
          case 'not-allowed':
            errorMessage = "‚ùó Microphone permission denied. Please allow microphone access.";
            break;
          case 'network':
            errorMessage = "‚ùó Network error. Please check your connection.";
            break;
          default:
            // Don't show error for non-critical errors that might auto-resolve
            if (!criticalErrors.includes(event.error)) {
              console.log(`Non-critical error: ${event.error}, continuing...`);
              return;
            }
            errorMessage = `‚ùó Error: ${event.error}. Please try again.`;
        }
        
        if (errorMessage) {
          this.addAssistantMessage(errorMessage);
        }
      };
    } catch (error) {
      console.error("Failed to initialize speech recognition:", error);
      this.addAssistantMessage("‚ùó Failed to initialize voice recognition. Please refresh the page.");
    }
  }

  bindEvents() {
    // Voice button events
    if (this.voiceBtn) {
      this.voiceBtn.onclick = async () => {
        if (this.isListening) {
          // Stop listening
          this.isListening = false;
          if (this.recognition) {
            try {
              this.recognition.stop();
            } catch (e) {
              console.log("Error stopping recognition:", e);
            }
          }
          this.updateListening(false);
          return;
        }
        
        // Check if recognition is initialized
        if (!this.recognition) {
          // Try to reinitialize
          this.initializeSpeechRecognition();
          if (!this.recognition) {
            this.addAssistantMessage("‚ùó Voice recognition not initialized. Please refresh the page.");
            return;
          }
        }
        
        try {
          // Request microphone permission first
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          // Stop the stream immediately after getting permission
          for (const track of stream.getTracks()) {
            track.stop();
          }
          
          // Start recognition
          if (this.recognition) {
            this.isListening = true; // Set flag first
            try {
              this.recognition.start();
              this.updateListening(true);
            } catch (startError) {
              console.error("Error starting recognition:", startError);
              this.isListening = false;
              this.updateListening(false);
              if (startError.name === 'InvalidStateError') {
                // Recognition might already be running, try to stop and restart
                try {
                  this.recognition.stop();
                  setTimeout(() => {
                    if (this.isListening && this.recognition) {
                      this.recognition.start();
                      this.updateListening(true);
                    }
                  }, 300);
                } catch (e) {
                  this.addAssistantMessage("‚ùó Failed to start voice recognition. Please try again.");
                }
              } else {
                this.addAssistantMessage("‚ùó Failed to start voice recognition. Please try again.");
              }
            }
          }
        } catch (error) {
          console.error("Microphone permission error:", error);
          this.isListening = false;
          this.updateListening(false);
          let errorMsg = "‚ùó Microphone permission is required for voice input.";
          if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMsg = "‚ùó Microphone permission denied. Please allow microphone access in your browser settings.";
          } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMsg = "‚ùó No microphone found. Please connect a microphone.";
          }
          this.addAssistantMessage(errorMsg);
        }
      };
    }
    
    if (this.stopBtn && this.recognition) {
      this.stopBtn.onclick = () => {
        if (this.isListening) {
          this.recognition.stop();
        }
      };
    }
    
    if (this.languageSelect && this.recognition) {
      this.languageSelect.onchange = (e) => {
        this.currentLanguage = e.target.value;
        if (this.recognition) {
          this.recognition.lang = this.currentLanguage;
        }
      };
      // Set initial language
      if (this.recognition) {
        this.recognition.lang = this.languageSelect.value || 'en-US';
      }
    }
    
    if (this.themeToggle) {
      this.themeToggle.onclick = () => this.toggleTheme();
    }
    
    const pauseBtn = document.getElementById('pauseBtn');
    if (pauseBtn) {
      pauseBtn.onclick = () => {
        const speechSynthesis = globalThis.speechSynthesis;
        if (speechSynthesis) {
          speechSynthesis.pause();
        }
      };
    }
    
    const resumeBtn = document.getElementById('resumeBtn');
    if (resumeBtn) {
      resumeBtn.onclick = () => {
        const speechSynthesis = globalThis.speechSynthesis;
        if (speechSynthesis) {
          speechSynthesis.resume();
        }
      };
    }
    
    // Text input events
    if (this.sendBtn) {
      this.sendBtn.onclick = () => this.sendTextMessage();
    }
    
    if (this.textInput) {
      this.textInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendTextMessage();
        }
      });
    }
    
    // Voice toggle button removed from typing area - voice functionality available via sidebar button
  }

  sendTextMessage() {
    if (this.textInput && this.textInput.value.trim()) {
      const message = this.textInput.value.trim();
      this.textInput.value = '';
      this.addUserMessage(message);
      this.fetchAnswerFromAPI(message);
    }
  }

  updateListening(isListening) {
    this.isListening = isListening;
    if (this.voiceBtn) {
      const voiceIcon = document.getElementById('voiceIcon');
      const voiceText = document.getElementById('voiceText');
      
      if (isListening) {
        this.voiceBtn.classList.add('btn-listening');
        this.voiceBtn.classList.remove('btn-primary');
        if (voiceIcon) voiceIcon.textContent = 'üõë';
        if (voiceText) voiceText.textContent = 'Stop Listening';
      } else {
        this.voiceBtn.classList.remove('btn-listening');
        this.voiceBtn.classList.add('btn-primary');
        if (voiceIcon) voiceIcon.textContent = 'üé§';
        if (voiceText) voiceText.textContent = 'Start Speaking';
      }
    }
    if (this.stopBtn) {
      this.stopBtn.style.display = isListening ? 'inline-block' : 'none';
    }
    if (this.statusBadge) {
      this.statusBadge.className = `status-badge ${isListening ? 'status-listening' : 'status-online'}`;
      this.statusBadge.innerHTML = `<div class="status-indicator"></div><span>${isListening ? 'üé§ Listening...' : 'Online'}</span>`;
    }
  }

  startSessionTimer() {
    setInterval(() => {
      const elapsed = Math.floor((Date.now() - this.sessionStartTime) / 1000);
      const min = Math.floor(elapsed / 60);
      const sec = (elapsed % 60).toString().padStart(2, '0');
      this.sessionTime.textContent = `${min}:${sec}`;
    }, 1000);
  }

  loadWelcome() {
    this.addAssistantMessage("Welcome! Ask me a medical question by voice or quick action.");
  }

  handleTranscript(text) {
    if (!text || !text.trim()) {
      console.log("Empty transcript received, ignoring...");
      return;
    }
    
    console.log("Processing transcript:", text);
    this.addUserMessage(text);
    this.fetchAnswerFromAPI(text);
  }

  showTypingIndicator() {
    if (this.typingIndicator) {
      this.typingIndicator.style.display = 'block';
      this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    }
  }

  hideTypingIndicator() {
    if (this.typingIndicator) {
      this.typingIndicator.style.display = 'none';
    }
  }

  async fetchAnswerFromAPI(query) {
    this.showTypingIndicator();

    const languageSelect = document.getElementById("language");
    const languageCode = languageSelect ? languageSelect.value : "en-US";
    
    // Convert language code to backend expected format
    const languageMap = {
      "hi-IN": "hindi",
      "en-US": "english",
      "en-GB": "english",
      "es-ES": "spanish",
      "fr-FR": "french",
      "de-DE": "german",
      "it-IT": "italian",
      "pt-PT": "portuguese",
      "ja-JP": "japanese",
      "ko-KR": "korean",
      "zh-CN": "chinese",
      "ar-SA": "arabic"
    };
    
    const language = languageMap[languageCode] || "english";

    try {
      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, language })
      });

      const data = await res.json();
      const answer = data.answer || "‚ö†Ô∏è No answer received.";
      this.hideTypingIndicator();
      this.addAssistantMessage(answer);
      
      // Speak the answer (always speak for better UX)
      // Use languageCode for TTS (needs BCP 47 format like "hi-IN")
      this.speakText(answer, languageCode);
    } catch (err) {
      console.error('Error fetching answer from API:', err);
      this.hideTypingIndicator();
      this.addAssistantMessage("‚ùó Failed to contact server. Please try again.");
    }
}
  speakText(text, language) {
    if (!globalThis.speechSynthesis) {
      console.warn("Speech synthesis not supported");
      return;
    }

    const speechSynthesis = globalThis.speechSynthesis;

    // Remove emojis and special symbols before speaking
    const emojiPattern = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;
    const cleanText = text.replace(emojiPattern, "").trim();
    
    if (!cleanText) {
      return;
    }

    // Cancel any ongoing speech
    speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(cleanText);

    // Choose voice language based on language code
    if (language && language.includes("hi")) {
      utterance.lang = "hi-IN";  // Hindi voice
    } else if (language && language.includes("es")) {
      utterance.lang = "es-ES";  // Spanish voice
    } else if (language && language.includes("fr")) {
      utterance.lang = "fr-FR";  // French voice
    } else {
      utterance.lang = "en-US";  // English voice (default)
    }

    utterance.rate = 1;
    utterance.pitch = 1;
    utterance.volume = 1;

    // Wait for voices to load
    const setVoice = () => {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        let selectedVoice = null;
        if (language && language.includes("hi")) {
          selectedVoice = voices.find(v => v.lang.includes("hi") || v.lang.includes("Hindi"));
        } else if (language && language.includes("es")) {
          selectedVoice = voices.find(v => v.lang.includes("es") || v.lang.includes("Spanish"));
        } else if (language && language.includes("fr")) {
          selectedVoice = voices.find(v => v.lang.includes("fr") || v.lang.includes("French"));
        } else {
          selectedVoice = voices.find(v => v.lang.includes("en") || v.lang.includes("English"));
        }
        if (selectedVoice) {
          utterance.voice = selectedVoice;
        }
      }
      
      speechSynthesis.speak(utterance);
    };

    // If voices are already loaded
    if (speechSynthesis.getVoices().length > 0) {
      setVoice();
    } else {
      // Wait for voices to load
      speechSynthesis.onvoiceschanged = setVoice;
      // Fallback: try after a short delay
      setTimeout(() => {
        if (speechSynthesis.getVoices().length > 0) {
          setVoice();
        }
      }, 500);
    }
  }

  addUserMessage(text) {
    this.addMessage(text, 'user', 'üë§');
  }

  addAssistantMessage(text) {
    this.addMessage(text, 'assistant', 'ü§ñ');
  }

  addMessage(text, type, icon) {
    const msg = document.createElement('div');
    msg.className = 'message';
    msg.innerHTML = `
      <div class="message-${type}">
        <div class="message-avatar ${type === 'user' ? 'avatar-user' : 'avatar-assistant'}">${icon}</div>
        <div class="message-content">${this.convertToHTML(text)}</div>
      </div>
      <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
    `;
    this.messagesContainer.appendChild(msg);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    this.messageCounter++;
    this.messageCount.textContent = this.messageCounter;
    this.conversationHistory.push(text);
  }

  convertToHTML(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/- /g, "<li>")
      .replace(/\n/g, "<br>");
  }

  toggleTheme() {
    document.body.classList.toggle('dark-theme');
  }
}

// Support quick action buttons
function askQuickQuestion(question) {
  if (globalThis.medAssistApp) {
    globalThis.medAssistApp.addUserMessage(question);
    globalThis.medAssistApp.fetchAnswerFromAPI(question);
  }
}

function clearChat() {
  if (globalThis.medAssistApp && globalThis.medAssistApp.messagesContainer) {
    const messages = globalThis.medAssistApp.messagesContainer.querySelectorAll('.message');
    // Keep the welcome message
    if (messages.length > 1) {
      for (const [index, msg] of Array.from(messages).entries()) {
        if (index > 0) msg.remove();
      }
      globalThis.medAssistApp.messageCounter = 1;
      if (globalThis.medAssistApp.messageCount) {
        globalThis.medAssistApp.messageCount.textContent = '1';
      }
      globalThis.medAssistApp.conversationHistory = [];
    }
  }
}

function exportChat() {
  if (globalThis.medAssistApp && globalThis.medAssistApp.conversationHistory.length > 0) {
    const summary = globalThis.medAssistApp.conversationHistory.join('\n\n');
    const blob = new Blob([summary], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `medassist-chat-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  } else {
    alert('No conversation to export.');
  }
}

// Add event listeners for clear and export
document.addEventListener('DOMContentLoaded', () => {
  const clearChatBtn = document.getElementById('clearChat');
  const exportChatBtn = document.getElementById('exportChat');
  
  if (clearChatBtn) {
    clearChatBtn.addEventListener('click', clearChat);
  }
  
  if (exportChatBtn) {
    exportChatBtn.addEventListener('click', exportChat);
  }
});

document.addEventListener('DOMContentLoaded', () => {
  globalThis.medAssistApp = new MedAssistPro();
});
</script>
</main>
</html>

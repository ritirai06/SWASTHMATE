<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="yes">
    <title>Upload Prescription</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/legacy.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <style>
        /* Hero Section */
        .hero-section-prescription {
            background: linear-gradient(to bottom right, #eff6ff, #dbeafe, #bfdbfe);
            color: #1e293b;
            padding: 4rem 1rem;
            margin-bottom: 4rem;
            text-align: center;
        }

        .container-hero-prescription {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .medical-icons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .med-icon-pulse {
            font-size: 3rem;
            opacity: 0.8;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.5; }
        }

        .prescription-icon-wrapper {
            margin-bottom: 1.5rem;
        }

        .prescription-icon-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 5rem;
            height: 5rem;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            border-radius: 9999px;
            margin-bottom: 1rem;
        }

        .prescription-icon {
            font-size: 2.5rem;
        }

        .hero-title-prescription {
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .hero-title-prescription .font-bold {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .hero-subtitle-prescription {
            color: #475569;
            max-width: 42rem;
            margin: 0 auto;
            font-size: 1.125rem;
        }

        /* Main Container */
        .pb-16 {
            padding-bottom: 4rem;
        }

        .container-main-prescription {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
            margin-top: -2rem;
            position: relative;
            z-index: 10;
        }

        /* Upload Section */
        .upload-section-prescription {
            margin-bottom: 4rem;
        }

        .upload-card-prescription {
            max-width: 56rem;
            margin: 0 auto;
            background: white;
            border-radius: 0.625rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 3rem;
        }

        .upload-area-prescription {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 4rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .upload-area-prescription:hover {
            border-color: #93c5fd;
            background: rgba(239, 246, 255, 0.3);
        }

        .upload-area-prescription.dragging {
            border-color: #60a5fa;
            background: #eff6ff;
        }

        .upload-content-prescription {
            margin-bottom: 2rem;
        }

        .upload-icon-wrapper {
            margin-bottom: 1rem;
        }

        .upload-icon-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 5rem;
            height: 5rem;
            background: #dbeafe;
            border-radius: 9999px;
            margin-bottom: 1rem;
        }

        .upload-icon-svg {
            color: #2563eb;
        }

        .upload-text-primary {
            color: #4b5563;
            margin-bottom: 0.5rem;
        }

        .upload-text-secondary {
            color: #6b7280;
        }

        .upload-buttons-prescription {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-prescription {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-prescription:hover {
            background: #1d4ed8;
        }

        .btn-prescription svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .file-input-hidden {
            display: none;
        }

        .upload-formats-prescription {
            margin-top: 1.5rem;
            color: #6b7280;
            text-align: center;
        }

        /* Features Section */
        .features-section-prescription {
            margin-top: 4rem;
        }

        .container-features-prescription {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .features-grid-prescription {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            max-width: 80rem;
            margin: 0 auto;
        }

        .feature-card-prescription {
            text-align: center;
            padding: 1.5rem;
        }

        .feature-icon-circle {
            background: #dbeafe;
            width: 4rem;
            height: 4rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .feature-icon {
            font-size: 1.5rem;
        }

        .feature-title {
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .feature-description {
            color: #4b5563;
        }

        /* Disclaimer Section */
        .disclaimer-section-prescription {
            margin-top: 3rem;
        }

        .container-disclaimer-prescription {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .disclaimer-box-prescription {
            padding: 1.5rem;
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 0.75rem;
            max-width: 80rem;
            margin: 0 auto;
        }

        .disclaimer-text {
            color: #78350f;
            text-align: center;
        }

        .disclaimer-icon {
            margin-right: 0.5rem;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .hero-section-prescription {
                padding: 2rem 1rem;
                margin-bottom: 2rem;
            }

            .medical-icons-row {
                gap: 1rem;
            }

            .med-icon-pulse {
                font-size: 2rem;
            }

            .prescription-icon-circle {
                width: 4rem;
                height: 4rem;
            }

            .prescription-icon {
                font-size: 2rem;
            }

            .hero-title-prescription .font-bold {
                font-size: 1.25rem;
            }

            .hero-subtitle-prescription {
                font-size: 1rem;
            }

            .container-main-prescription {
                margin-top: -1rem;
            }

            .upload-card-prescription {
                padding: 1.5rem;
            }

            .upload-area-prescription {
                padding: 2rem 1rem;
            }

            .upload-icon-circle {
                width: 4rem;
                height: 4rem;
            }

            .upload-buttons-prescription {
                flex-direction: column;
                width: 100%;
            }

            .btn-prescription {
                width: 100%;
                justify-content: center;
            }

            .features-grid-prescription {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .disclaimer-box-prescription {
                padding: 1rem;
            }

            .disclaimer-text {
                font-size: 0.875rem;
            }
        }

        /* Medical pattern overlay */
        .comfort::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='80' height='80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23ffffff' stroke-width='0.5' opacity='0.1'%3E%3Cpath d='M20 20 L60 20 L60 60 L20 60 Z'/%3E%3Ccircle cx='40' cy='40' r='10'/%3E%3Cpath d='M40 30 L40 50 M30 40 L50 40'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 80px 80px;
            pointer-events: none;
        }

        .medical-banner-icons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .banner-med-icon {
            font-size: 2rem;
            animation: floatIcon 3s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .banner-med-icon:nth-child(1) { animation-delay: 0s; }
        .banner-med-icon:nth-child(2) { animation-delay: 0.6s; }
        .banner-med-icon:nth-child(3) { animation-delay: 1.2s; }
        .banner-med-icon:nth-child(4) { animation-delay: 1.8s; }
        .banner-med-icon:nth-child(5) { animation-delay: 2.4s; }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
        }

        .comfort h1, .comfort p {
            position: relative;
            z-index: 1;
        }

        .comfort h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .comfort p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-comfort {
            padding: 40px;
        }

        .up-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .up-section:hover {
            border-color: #2f4eda;
            background: #f1f3f4;
        }

        .up-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 30px auto;
            max-width: 600px;
        }

        .b {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            min-width: 180px;
        }

        .b::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(41, 28, 227, 0.3), transparent);
            transition: left 0.5s;
        }

        .b:hover::before {
            left: 100%;
        }

        .b-primary {
            background: linear-gradient(135deg, #1c39bb 0%, #d1ccd6 100%);
            color: white;
        }

        .b-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 74, 238, 0.3);
        }

        .b-secondary {
            background: linear-gradient(135deg, #1d4ed8 0%, #1d4ed8 100%);
            color: white;
        }

        .b-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px #1d4ed8;
        }

        .b:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .preview-section {
            display: none;
            margin-top: 30px;
        }

        .image-preview {
            text-align: center;
            margin-bottom: 30px;
        }

        .preview-img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .video-container {
            position: relative;
            display: none;
            text-align: center;
            margin-bottom: 20px;
        }

        #camera-stream {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .capture-b {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .capture-b:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .close-camera-b {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-camera-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .results-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid #e9ecef;
        }

        .results-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .extracted-text {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .confidence-score {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .medical-entities {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .entity-group {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .entity-type {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .entity-values {
            color: #495057;
            font-style: italic;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Progress Tracker Styles */
        .progress-tracker-section {
            margin-bottom: 4rem;
        }

        .progress-tracker-container {
            position: relative;
            margin: 2rem 0;
        }

        .progress-steps-wrapper {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
            margin-bottom: 1rem;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 3px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            z-index: 3;
        }

        .progress-step.active .step-circle {
            border-color: #667eea;
            background: #667eea;
            color: white;
            box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1);
        }

        .progress-step.completed .step-circle {
            border-color: #10b981;
            background: #10b981;
            color: white;
        }

        .progress-step.completed .step-circle::after {
            content: '‚úì';
            font-size: 1.5rem;
            font-weight: bold;
            position: absolute;
        }

        .step-number {
            font-size: 1.25rem;
            font-weight: 600;
            color: #6b7280;
        }

        .progress-step.active .step-number {
            color: white;
        }

        .progress-step.completed .step-number {
            display: none;
        }

        .step-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
        }

        .progress-step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .progress-step.completed .step-label {
            color: #10b981;
        }

        .progress-line {
            position: absolute;
            top: 30px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e5e7eb;
            z-index: 1;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-status-text {
            text-align: center;
            font-size: 1.125rem;
            color: #475569;
            font-weight: 500;
            margin-top: 1rem;
        }

        .report-action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-view-report {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-view-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-download-report {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-download-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .report-display-section {
            margin-bottom: 4rem;
        }

        .file-input {
            display: none;
        }

        .drag-drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .drag-drop-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #d63031;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
                margin: 0;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1rem;
            }

            .main-content {
                padding: 20px 15px;
            }

            .upload-section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .upload-section h2 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }

            .upload-buttons {
                flex-direction: column;
                align-items: center;
                gap: 15px;
                margin-top: 20px;
                max-width: 100%;
            }

            .b {
                width: 100%;
                max-width: 280px;
                padding: 18px 25px;
                font-size: 1rem;
                min-width: auto;
            }

            .drag-drop-area {
                padding: 25px 15px;
                margin: 15px 0;
            }

            .drag-drop-area p {
                font-size: 0.9rem;
            }

            .video-container {
                margin: 0 -15px;
                border-radius: 0;
            }

            #camera-stream {
                width: 100%;
                height: auto;
                border-radius: 0;
                max-height: 60vh;
                object-fit: cover;
            }

            .capture-b {
                width: 60px;
                height: 60px;
                bottom: 15px;
                font-size: 1.3rem;
            }

            .close-camera-b {
                width: 45px;
                height: 45px;
                top: 15px;
                right: 15px;
                font-size: 1.1rem;
            }

            .preview-img {
                max-height: 300px;
                margin: 0 -15px 20px -15px;
                border-radius: 0;
                width: calc(100% + 30px);
            }

            .image-preview div {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 0 15px;
            }

            .results-section {
                padding: 20px 15px;
                margin-top: 20px;
            }

            .results-box {
                padding: 15px;
                margin-top: 15px;
            }

            .results-header {
                padding: 12px 15px;
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            .results-section h3 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .extracted-text {
                padding: 15px;
                font-size: 0.9rem;
                max-height: 200px;
                overflow-y: auto;
            }

            .confidence-score {
                padding: 8px 16px;
                font-size: 0.9rem;
                margin-bottom: 10px;
            }

            .loading p {
                font-size: 0.9rem;
            }

            .spinner {
                width: 40px;
                height: 40px;
                margin-bottom: 15px;
            }

            .error-message {
                padding: 12px;
                font-size: 0.9rem;
                margin: 15px -15px;
                border-radius: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .main-content {
                padding: 15px 10px;
            }

            .upload-section {
                padding: 15px 10px;
            }

            .upload-section h2 {
                font-size: 1.1rem;
            }

            .btn {
                padding: 16px 20px;
                font-size: 0.95rem;
                max-width: 100%;
            }

            .drag-drop-area {
                padding: 20px 10px;
            }

            .drag-drop-area p {
                font-size: 0.85rem;
            }

            #camera-stream {
                max-height: 50vh;
            }

            .capture-b {
                width: 55px;
                height: 55px;
                font-size: 1.2rem;
            }

            .close-camera-b {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .preview-img {
                max-height: 250px;
            }

            .results-section {
                padding: 15px 10px;
            }

            .results-box {
                padding: 12px;
            }

            .extracted-text {
                padding: 12px;
                font-size: 0.85rem;
                max-height: 150px;
            }

            .confidence-score {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }

        /* Landscape orientation for mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            #camera-stream {
                max-height: 70vh;
            }

            .preview-img {
                max-height: 250px;
            }
        }

        /* Touch-friendly adjustments */
        @media (pointer: coarse) {
            .btn {
                min-height: 48px;
                touch-action: manipulation;
            }

            .capture-btn {
                min-width: 60px;
                min-height: 60px;
                touch-action: manipulation;
            }

            .close-camera-btn {
                min-width: 45px;
                min-height: 45px;
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body style="padding-top: 64px;">
    <!-- Header -->
    <header class="header-modern">
        <div class="container-modern">
            <div class="navbar-modern">
                <!-- Logo -->
                <div class="logo-modern">
                    <div class="logo-icon-modern">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="Swasthmate Logo">
                    </div>
                    <span class="logo-text-modern">Swasth<span class="mate-part">mate</span></span>
                </div>

                <!-- Desktop Navigation -->
                <nav class="nav-modern">
                    <a href="/" class="nav-link-modern">Home</a>
                    <a href="/upload" class="nav-link-modern">Prescription Reader</a>
                    <a href="/MedAssist" class="nav-link-modern">MedAssist</a>
                    <a href="/about" class="nav-link-modern" onclick="window.location.href='/about'; return true;">About Us</a>
                    <a href="/contact" class="nav-link-modern" onclick="window.location.href='/contact'; return true;">Contact</a>
                </nav>

                <!-- Right Side Actions -->
                <div class="header-actions-modern">
                    <div id="loginButtonContainer">
                        <a href="/login" class="login-btn-modern">Log In / Sign up</a>
                    </div>
                    <div id="profileButtonContainer" class="profile-container-modern" style="display: none;">
                        <button class="user-icon-btn" onclick="toggleProfileDropdown()">
                            <i class="fas fa-user"></i>
                        </button>
                        <div class="profile-dropdown-modern" id="profileDropdownModern">
                            <div class="profile-header-modern">
                                <div class="profile-info-modern">
                                    <div class="profile-avatar-modern" id="profileAvatarModern">U</div>
                                    <div class="profile-details-modern">
                                        <h3 id="dropdown-user-name-modern">User</h3>
                                        <p id="dropdown-user-email-modern">user@example.com</p>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-menu-modern">
                                <a href="#" class="profile-menu-item-modern" onclick="editProfile(); return false;">
                                    <i class="fas fa-edit"></i>
                                    Edit Profile
                                </a>
                                <button class="profile-menu-item-modern logout-modern" onclick="handleLogout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
                
            <!-- Mobile Menu -->
            <div class="mobile-menu" id="mobileMenu">
                <nav class="mobile-nav">
                    <a href="/" class="mobile-nav-link" onclick="window.location.href='/'; return true;">Home</a>
                    <a href="/upload" class="mobile-nav-link" onclick="window.location.href='/upload'; return true;">Prescription Reader</a>
                    <a href="/MedAssist" class="mobile-nav-link" onclick="window.location.href='/MedAssist'; return true;">MedAssist</a>
                    <a href="/about" class="mobile-nav-link" onclick="window.location.href='/about'; return true;">About Us</a>
                    <a href="/contact" class="mobile-nav-link" onclick="window.location.href='/contact'; return true;">Contact</a>
                </nav>
            </div>
        </div>
    </header>
    

    <!-- Profile Modal -->
    <section id="profile-view" style="display: none;">
        <div class="profile-modal">
            <button class="close-profile" onclick="closeProfile()">&times;</button>
            <h2>My Profile</h2>
           <form id="edit-profile-form">
    <p><strong>Name:</strong> <input type="text" id="edit-name" required></p>
    <p><strong>Email:</strong> <input type="email" id="edit-email" required></p>
    <p><strong>Password:</strong> <input type="password" id="edit-password" required></p>
    <button type="submit" class="demo-button">Save Changes</button>
    </form>
            
    </section>

    <!-- Hero Section -->
    <div class="hero-section-prescription">
        <div class="container-hero-prescription">
            <!-- Medical Icons -->
            <div class="medical-icons-row">
                <span class="med-icon-pulse" style="animation-delay: 0s;">üíä</span>
                <span class="med-icon-pulse" style="animation-delay: 0.2s;">üß¨</span>
                <span class="med-icon-pulse" style="animation-delay: 0.4s;">‚öïÔ∏è</span>
            </div>

            <!-- Prescription Icon -->
            <div class="prescription-icon-wrapper">
                <div class="prescription-icon-circle">
                    <span class="prescription-icon">üìã</span>
                </div>
            </div>

            <!-- Title -->
            <h1 class="hero-title-prescription">
                <span class="font-bold">Prescription Reader</span>
            </h1>

            <!-- Subtitle -->
            <p class="hero-subtitle-prescription">
                Capture or upload a prescription to extract text and analyze medical entities.
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pb-16">
        <div class="container-main-prescription">
            <!-- Upload Section -->
            <div id="uploadSection" class="upload-section-prescription">
                <div class="upload-card-prescription">
                    <div class="upload-area-prescription" id="uploadArea">
                        <div class="upload-content-prescription">
                            <div class="upload-icon-wrapper">
                                <div class="upload-icon-circle">
                                    <svg class="upload-icon-svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                </div>
                            </div>
                            <p class="upload-text-primary">Drag and drop your medical report here</p>
                            <p class="upload-text-secondary">or use one of the options below</p>
                        </div>

                        <div class="upload-buttons-prescription">
                            <button class="btn-prescription btn-camera" id="cameraBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                OPEN CAMERA
                            </button>
                            <button class="btn-prescription btn-upload" id="uploadBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                UPLOAD REPORT
                            </button>
                        </div>

                        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" class="file-input-hidden">
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="file-input-hidden">
                    </div>
                    <div class="upload-formats-prescription">
                        Supported formats: PDF, JPG, PNG, JPEG (Max 10MB)
                    </div>
                </div>
            </div>

            <!-- Progress Tracker Section (Hidden by default) -->
            <div id="progressTrackerSection" class="progress-tracker-section" style="display: none;">
                <div class="upload-card-prescription">
                    <h2 style="text-align: center; margin-bottom: 2rem; color: #1e293b;">üìä Processing Your Report</h2>
                    
                    <!-- Progress Steps -->
                    <div class="progress-tracker-container">
                        <div class="progress-steps-wrapper">
                            <div class="progress-step" id="step1">
                                <div class="step-circle">
                                    <span class="step-number">1</span>
                                </div>
                                <div class="step-label">Uploading</div>
                            </div>
                            <div class="progress-step" id="step2">
                                <div class="step-circle">
                                    <span class="step-number">2</span>
                                </div>
                                <div class="step-label">Analysis</div>
                            </div>
                            <div class="progress-step" id="step3">
                                <div class="step-circle">
                                    <span class="step-number">3</span>
                                </div>
                                <div class="step-label">Processing</div>
                            </div>
                            <div class="progress-step" id="step4">
                                <div class="step-circle">
                                    <span class="step-number">4</span>
                                </div>
                                <div class="step-label">Report</div>
                            </div>
                        </div>
                        <div class="progress-line">
                            <div class="progress-line-fill" id="progressLineFill"></div>
                        </div>
                    </div>
                    
                    <div class="progress-status-text" id="progressStatusText">Preparing to upload...</div>
                    
                    <!-- Action Buttons (Hidden until completion) -->
                    <div id="reportActionButtons" class="report-action-buttons" style="display: none; margin-top: 2rem;">
                        <button class="btn-prescription btn-view-report" id="viewReportBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            VIEW REPORT
                        </button>
                        <button class="btn-prescription btn-download-report" id="downloadReportBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            DOWNLOAD REPORT
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Display Section (Hidden by default) -->
            <div id="reportDisplaySection" class="report-display-section" style="display: none;">
                <div class="upload-card-prescription">
                    <div id="reportContent"></div>
                </div>
            </div>

            <!-- Video Container (Hidden by default) -->
            <div class="video-container" id="videoContainer" style="display: none;">
                <video id="camera-stream" autoplay playsinline></video>
                <button class="capture-b" id="captureBtn">üì∑</button>
                <button class="close-camera-b" id="closeCameraBtn">‚ùå</button>
            </div>

            <!-- Preview Section (Hidden by default) -->
            <div id="previewSection" class="preview-section" style="display: none;">
                <div class="image-preview">
                    <img id="preview-img" class="preview-img" />
                    <div>
                        <button class="b b-primary" id="processBtn">üîç Extract Text</button>
                        <button class="b b-secondary" id="retakeBtn">üîÑ Retake</button>
                    </div>
                </div>
            </div>

            <!-- Results Section (Hidden by default) -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="results-header">
                    üìã Analysis Report
                </div>
                
                <div id="loadingIndicator" class="loading">
                    <div class="spinner"></div>
                    <p>‚è≥ Processing your prescription...</p>
                </div>
                
                <div id="extractedResults" class="results-box" style="display: none;">
                    <h3>üìÑ Extracted Text</h3>
                    <div id="confidenceScore" class="confidence-score"></div>
                    <div id="extractedText" class="extracted-text"></div>
                    <button class="btn btn-secondary" id="copyBtn">üìã Copy Text</button>
                    
                    <div class="medical-entities">
                        <h3>üß¨ Medical Entities Detected</h3>
                        <div id="entityList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="features-section-prescription">
            <div class="container-features-prescription">
                <div class="features-grid-prescription">
                    <div class="feature-card-prescription">
                        <div class="feature-icon-circle">
                            <span class="feature-icon">üîç</span>
                        </div>
                        <h3 class="feature-title">AI-Powered OCR</h3>
                        <p class="feature-description">
                            Advanced optical character recognition extracts text with high accuracy
                        </p>
                    </div>
                    <div class="feature-card-prescription">
                        <div class="feature-icon-circle">
                            <span class="feature-icon">üíä</span>
                        </div>
                        <h3 class="feature-title">Medical Entity Analysis</h3>
                        <p class="feature-description">
                            Identifies medications, dosages, and medical instructions automatically
                        </p>
                    </div>
                    <div class="feature-card-prescription">
                        <div class="feature-icon-circle">
                            <span class="feature-icon">üîí</span>
                        </div>
                        <h3 class="feature-title">Secure & Private</h3>
                        <p class="feature-description">
                            Your prescription data is processed securely and never stored without consent
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer-section-prescription">
            <div class="container-disclaimer-prescription">
                <div class="disclaimer-box-prescription">
                    <p class="disclaimer-text">
                        <span class="disclaimer-icon">‚ö†Ô∏è</span>
                        <strong>Medical Disclaimer:</strong> This tool is for informational purposes only and should not replace professional medical advice. Always consult with your healthcare provider or pharmacist for medical advice and prescription verification. Do not use for storing sensitive medical information.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer-modern">
        <div class="container-modern">
            <div class="footer-grid-modern">
                <!-- Brand -->
                <div class="footer-brand">
                    <div class="footer-logo-modern">
                        <div class="logo-icon-modern">
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="Swasthmate Logo">
                        </div>
                        <span class="logo-text-modern">Swasth<span class="mate-part">mate</span></span>
                    </div>
                    <p class="footer-description-modern">
                        AI-powered medical report analysis for better health insights.
                    </p>
                    <div class="social-links-modern">
                        <a href="#" class="social-link-modern"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link-modern"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link-modern"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" class="social-link-modern"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul class="footer-links-modern">
                        <li><a href="/">Home</a></li>
                        <li><a href="/upload">Prescription Reader</a></li>
                        <li><a href="/MedAssist">MedAssist</a></li>
                        <li><a href="/about">About Us</a></li>
                    </ul>
                </div>
                
                <!-- Services -->
                <div class="footer-column">
                    <h4>Services</h4>
                    <ul class="footer-links-modern">
                        <li><a href="/upload">Prescription Reader</a></li>
                        <li><a href="/MedAssist">MedAssist</a></li>
                        <li><a href="/">Report Analysis</a></li>
                        <li><a href="/contact">Contact</a></li>
                    </ul>
                </div>
                
                <!-- Contact -->
                <div class="footer-column">
                    <h4>Contact Us</h4>
                    <ul class="footer-contact-modern">
                        <li>
                            <i class="fas fa-envelope"></i>
                            <span>support@medscan.ai</span>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <span>+91-9005529331</span>
                        </li>
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span>India</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Bottom Bar -->
            <div class="footer-bottom-modern">
                <p>¬© 2025 Swasthmate. All rights reserved.</p>
                <div class="footer-legal-links-modern">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>
    <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Check if user is logged in
        function checkLoginStatus() {
            const userData = localStorage.getItem('userData');
            const loginContainer = document.getElementById('loginButtonContainer');
            const profileContainer = document.getElementById('profileButtonContainer');
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.loggedIn) {
                        if (loginContainer) loginContainer.style.display = 'none';
                        if (profileContainer) {
                            profileContainer.style.display = 'flex';
                            profileContainer.style.visibility = 'visible';
                            profileContainer.style.alignItems = 'center';
                        }
                        
                        const avatar = document.getElementById('profileAvatarModern');
                        const nameEl = document.getElementById('dropdown-user-name-modern');
                        const emailEl = document.getElementById('dropdown-user-email-modern');
                        
                        if (avatar) avatar.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                        if (nameEl) nameEl.textContent = user.name || 'User';
                        if (emailEl) emailEl.textContent = user.email || 'user@example.com';
                    } else {
                        if (loginContainer) loginContainer.style.display = 'block';
                        if (profileContainer) profileContainer.style.display = 'none';
                    }
                } catch (e) {
                    if (loginContainer) loginContainer.style.display = 'block';
                    if (profileContainer) profileContainer.style.display = 'none';
                }
            } else {
                if (loginContainer) loginContainer.style.display = 'block';
                if (profileContainer) profileContainer.style.display = 'none';
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdownModern');
            if (dropdown) dropdown.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            const profileContainer = document.getElementById('profileButtonContainer');
            const dropdown = document.getElementById('profileDropdownModern');
            if (profileContainer && dropdown && !profileContainer.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function handleLogout() {
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        function editProfile() {
            const userData = localStorage.getItem('userData');
            const profileView = document.getElementById('profile-view');
            const dropdown = document.getElementById('profileDropdownModern');
            
            if (dropdown) dropdown.classList.remove('active');
            
            if (userData) {
                const user = JSON.parse(userData);
                const nameInput = document.getElementById('edit-name');
                const emailInput = document.getElementById('edit-email');
                const passwordInput = document.getElementById('edit-password');
                
                if (nameInput) nameInput.value = user.name || '';
                if (emailInput) emailInput.value = user.email || '';
                if (passwordInput) passwordInput.value = user.password || '';
            }
            
            if (profileView) {
                profileView.style.display = 'flex';
                profileView.classList.add('active');
            }
        }

        function closeProfile() {
            const profileView = document.getElementById('profile-view');
            if (profileView) {
                profileView.style.display = 'none';
                profileView.classList.remove('active');
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu) menu.classList.toggle('active');
        }

        const editProfileForm = document.getElementById('edit-profile-form');
        if (editProfileForm) {
            editProfileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('edit-name').value;
                const email = document.getElementById('edit-email').value;
                const password = document.getElementById('edit-password').value;
                
                if (!name || !email) {
                    alert('Please fill in name and email');
                    return;
                }
                
                const userData = localStorage.getItem('userData');
                const existingUser = userData ? JSON.parse(userData) : {};
                
                const updatedUser = {
                    name: name,
                    email: email,
                    password: password || existingUser.password || '',
                    loggedIn: true
                };
                
                localStorage.setItem('userData', JSON.stringify(updatedUser));
                checkLoginStatus();
                closeProfile();
                alert('Profile updated successfully!');
            });
        }

    document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        
        // Initialize report view and download buttons
        const viewReportBtn = document.getElementById('viewReportBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        
        if (viewReportBtn) {
            viewReportBtn.addEventListener('click', function() {
                const reportData = sessionStorage.getItem('reportData');
                if (reportData) {
                    try {
                        const data = JSON.parse(reportData);
                        showReport(data);
                    } catch (e) {
                        alert('Error loading report data');
                    }
                } else {
                    alert('No report data found. Please upload a report first.');
                }
            });
        }
        
        if (downloadReportBtn) {
            downloadReportBtn.addEventListener('click', function() {
                const reportData = sessionStorage.getItem('reportData');
                if (reportData) {
                    try {
                        const data = JSON.parse(reportData);
                        downloadReport(data);
                    } catch (e) {
                        alert('Error downloading report');
                    }
                } else {
                    alert('No report data found. Please upload a report first.');
                }
            });
        }
    });

    function showReport(data) {
        const uploadSection = document.getElementById('uploadSection');
        const progressSection = document.getElementById('progressTrackerSection');
        const reportDisplaySection = document.getElementById('reportDisplaySection');
        const reportContent = document.getElementById('reportContent');
        
        if (uploadSection) uploadSection.style.display = 'none';
        if (progressSection) progressSection.style.display = 'none';
        if (reportDisplaySection) reportDisplaySection.style.display = 'block';
        
        if (reportContent) {
            // Create a temporary div to render the report
            const tempDiv = document.createElement('div');
            tempDiv.id = 'analysis-result';
            document.body.appendChild(tempDiv);
            
            // Use displayResults if available
            if (window.displayResults) {
                window.displayResults(data);
                // Copy the rendered content
                setTimeout(() => {
                    const analysisResult = document.getElementById('analysis-result');
                    if (analysisResult && analysisResult.innerHTML) {
                        reportContent.innerHTML = analysisResult.innerHTML;
                    }
                    document.body.removeChild(tempDiv);
                }, 100);
            } else {
                // Fallback display
                reportContent.innerHTML = `
                    <h2 style="margin-bottom: 1rem; color: #1e293b;">üìä Medical Report Analysis</h2>
                    <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p><strong>Filename:</strong> ${data.filename || 'N/A'}</p>
                        <p><strong>Report ID:</strong> ${data.report_id || 'N/A'}</p>
                        ${data.analysis ? `<p><strong>Diseases:</strong> ${(data.analysis.diseases || []).join(', ') || 'None'}</p>` : ''}
                        ${data.enhanced_analysis ? `<p><strong>Summary:</strong> ${data.enhanced_analysis.summary_text || 'N/A'}</p>` : ''}
                    </div>
                `;
            }
        }
        
        // Scroll to report
        if (reportDisplaySection) {
            reportDisplaySection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function downloadReport(data) {
        // Create a formatted report text
        let reportText = 'MEDICAL REPORT ANALYSIS\n';
        reportText += '='.repeat(50) + '\n\n';
        reportText += `Filename: ${data.filename || 'N/A'}\n`;
        reportText += `Report ID: ${data.report_id || 'N/A'}\n`;
        reportText += `Date: ${new Date().toLocaleString()}\n\n`;
        
        if (data.analysis) {
            reportText += 'ANALYSIS RESULTS\n';
            reportText += '-'.repeat(50) + '\n';
            reportText += `Diseases: ${(data.analysis.diseases || []).join(', ') || 'None'}\n`;
            reportText += `Medications: ${(data.analysis.medications || []).join(', ') || 'None'}\n`;
            reportText += `Specialization: ${data.analysis.specialization || 'N/A'}\n\n`;
        }
        
        if (data.enhanced_analysis) {
            reportText += 'ENHANCED ANALYSIS\n';
            reportText += '-'.repeat(50) + '\n';
            reportText += `${data.enhanced_analysis.summary_text || 'N/A'}\n\n`;
        }
        
        if (data.recommendations && data.recommendations.length > 0) {
            reportText += 'RECOMMENDATIONS\n';
            reportText += '-'.repeat(50) + '\n';
            data.recommendations.forEach((rec, i) => {
                reportText += `${i + 1}. ${rec}\n`;
            });
        }
        
        // Create blob and download
        const blob = new Blob([reportText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `medical_report_${data.report_id || Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    </script>
<script>
    class PrescriptionReader {
        constructor() {
            this.currentStream = null;
            this.capturedImage = null;
            this.currentReportData = null;
            this.initializeElements();
            this.setupEventListeners();
        }

        initializeElements() {
            this.elements = {
                cameraBtn: document.getElementById('cameraBtn'),
                uploadBtn: document.getElementById('uploadBtn'),
                fileInput: document.getElementById('fileInput'),
                cameraInput: document.getElementById('cameraInput'),
                videoContainer: document.getElementById('videoContainer'),
                cameraStream: document.getElementById('camera-stream'),
                captureBtn: document.getElementById('captureBtn'),
                closeCameraBtn: document.getElementById('closeCameraBtn'),
                previewSection: document.getElementById('previewSection'),
                previewImg: document.getElementById('preview-img'),
                processBtn: document.getElementById('processBtn'),
                retakeBtn: document.getElementById('retakeBtn'),
                resultsSection: document.getElementById('resultsSection'),
                loadingIndicator: document.getElementById('loadingIndicator'),
                extractedResults: document.getElementById('extractedResults'),
                extractedText: document.getElementById('extractedText'),
                confidenceScore: document.getElementById('confidenceScore'),
                copyBtn: document.getElementById('copyBtn'),
                dragDropArea: document.getElementById('dragDropArea'),
                progressFill: document.getElementById('progressFill')
            };
        }

        setupEventListeners() {
            // Drag and drop handlers
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragging');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragging');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragging');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.handleFile(file);
                    }
                });
            }

            if (this.elements.cameraBtn) {
                this.elements.cameraBtn.addEventListener('click', () => {
                    const user = JSON.parse(localStorage.getItem('userData'));
                    if (user && user.loggedIn) {
                        if (this.elements.cameraInput) {
                            this.elements.cameraInput.click();
                        } else {
                            this.openCamera();
                        }
                    } else {
                        alert('Please log in to use the camera.');
                        globalThis.location.href = '/login';
                    }
                });
            }

            if (this.elements.cameraInput) {
                this.elements.cameraInput.addEventListener('change', (e) => this.handleFileSelect(e));
            }

            if (this.elements.uploadBtn) {
                this.elements.uploadBtn.addEventListener('click', () => {
                    const user = JSON.parse(localStorage.getItem('userData'));
                    if (user && user.loggedIn) {
                        if (this.elements.fileInput) {
                            this.elements.fileInput.click();
                        }
                    } else {
                        alert('Please log in to upload a prescription.');
                        globalThis.location.href = '/login';
                    }
                });
            }

            if (this.elements.fileInput) {
                this.elements.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
            }
            if (this.elements.captureBtn) {
                this.elements.captureBtn.addEventListener('click', () => this.captureImage());
            }
            if (this.elements.closeCameraBtn) {
                this.elements.closeCameraBtn.addEventListener('click', () => this.stopCamera());
            }
            if (this.elements.processBtn) {
                this.elements.processBtn.addEventListener('click', () => {
                    // If we have a file, upload it as report
                    if (this.capturedImage) {
                        // Convert data URL to blob
                        fetch(this.capturedImage)
                            .then(res => res.blob())
                            .then(blob => {
                                const file = new File([blob], 'image.jpg', { type: 'image/jpeg' });
                                this.uploadReport(file);
                            });
                    } else {
                        this.processImage();
                    }
                });
            }
            if (this.elements.retakeBtn) {
                this.elements.retakeBtn.addEventListener('click', () => this.resetCapture());
            }
            if (this.elements.copyBtn) {
                this.elements.copyBtn.addEventListener('click', () => this.copyText());
            }

            if (this.elements.dragDropArea) {
                this.elements.dragDropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.elements.dragDropArea.classList.add('dragover');
                });

                this.elements.dragDropArea.addEventListener('dragleave', () => {
                    this.elements.dragDropArea.classList.remove('dragover');
                });

                this.elements.dragDropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.elements.dragDropArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });
            }
        }

        async openCamera() {
            try {
                const constraints = { video: { facingMode: 'environment' } };
                this.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                this.elements.cameraStream.srcObject = this.currentStream;
                this.elements.videoContainer.style.display = 'block';
                this.elements.cameraBtn.disabled = true;
            } catch (error) {
                this.showError('Camera access failed.');
            }
        }

        captureImage() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const video = this.elements.cameraStream;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            canvas.toBlob((blob) => {
                this.handleFile(blob);
                this.stopCamera();
            }, 'image/jpeg', 0.9);
        }

        stopCamera() {
            if (this.currentStream) {
                this.currentStream.getTracks().forEach(track => track.stop());
                this.currentStream = null;
            }
            this.elements.videoContainer.style.display = 'none';
            this.elements.cameraBtn.disabled = false;
        }

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.handleFile(file);
            }
        }

        handleFile(file) {
            // Check if it's a PDF or image
            const isImage = file.type?.startsWith('image/') || file instanceof Blob;
            const isPDF = file.type === 'application/pdf' || file.name?.toLowerCase().endsWith('.pdf');
            
            if (!isImage && !isPDF) {
                this.showError('Please select a valid PDF or image file.');
                return;
            }

            // For PDF files, directly upload to /upload endpoint
            if (isPDF) {
                this.uploadReport(file);
                return;
            }

            // For images, show preview first (existing behavior)
            const reader = new FileReader();
            reader.onload = (e) => {
                this.capturedImage = e.target.result;
                if (this.elements.previewImg) {
                    this.elements.previewImg.src = this.capturedImage;
                }
                if (this.elements.previewSection) {
                    this.elements.previewSection.style.display = 'block';
                }
                if (this.elements.resultsSection) {
                    this.elements.resultsSection.style.display = 'none';
                }
                if (this.elements.extractedResults) {
                    this.elements.extractedResults.innerHTML = '';
                }
            };
            reader.readAsDataURL(file);
        }

        async uploadReport(file) {
            // Hide upload section, show progress tracker
            const uploadSection = document.getElementById('uploadSection');
            const progressSection = document.getElementById('progressTrackerSection');
            const reportDisplaySection = document.getElementById('reportDisplaySection');
            
            if (uploadSection) uploadSection.style.display = 'none';
            if (progressSection) progressSection.style.display = 'block';
            if (reportDisplaySection) reportDisplaySection.style.display = 'none';

            // Initialize progress
            this.updateProgress(0, 'Uploading your report...');

            const formData = new FormData();
            formData.append('report', file);

            try {
                const xhr = new XMLHttpRequest();
                
                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const uploadPercent = (e.loaded / e.total) * 25; // 25% for upload
                        this.updateProgress(uploadPercent, 'Uploading your report...');
                    }
                });

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            this.handleUploadSuccess(data);
                        } catch (e) {
                            this.handleUploadError('Failed to parse response');
                        }
                    } else {
                        this.handleUploadError(`Upload failed: ${xhr.statusText}`);
                    }
                };

                xhr.onerror = () => {
                    this.handleUploadError('Network error occurred');
                };

                xhr.open('POST', '/upload');
                xhr.send(formData);
            } catch (error) {
                this.handleUploadError(error.message);
            }
        }

        updateProgress(percent, statusText) {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            const stepLabels = ['Uploading', 'Analysis', 'Processing', 'Report'];
            const progressLineFill = document.getElementById('progressLineFill');
            const progressStatusText = document.getElementById('progressStatusText');

            // Update progress line
            if (progressLineFill) {
                progressLineFill.style.width = Math.min(percent, 100) + '%';
            }

            // Update status text
            if (progressStatusText) {
                progressStatusText.textContent = statusText;
            }

            // Update steps
            const stepIndex = Math.floor((percent / 100) * 4);
            for (let i = 0; i < steps.length; i++) {
                const step = document.getElementById(steps[i]);
                if (step) {
                    step.classList.remove('active', 'completed');
                    if (i < stepIndex) {
                        step.classList.add('completed');
                    } else if (i === stepIndex) {
                        step.classList.add('active');
                    }
                }
            }
        }

        handleUploadSuccess(data) {
            console.log('üì§ Upload success:', data);
            
            // Step 1: Uploading (25%)
            this.updateProgress(25, 'Uploading your report...');
            
            setTimeout(() => {
                // Step 2: Analysis (50%)
                this.updateProgress(50, 'Analyzing with OCR and NLP...');
                
                setTimeout(() => {
                    // Step 3: Processing (75%)
                    this.updateProgress(75, 'Processing medical data...');
                    
                    setTimeout(() => {
                        // Step 4: Report (100%)
                        this.updateProgress(100, 'Report generated successfully!');
                        
                        // Store data
                        if (typeof sessionStorage !== 'undefined') {
                            sessionStorage.setItem('reportData', JSON.stringify(data));
                            sessionStorage.setItem('report_id', data.report_id || '');
                        }
                        
                        // Show action buttons
                        const actionButtons = document.getElementById('reportActionButtons');
                        if (actionButtons) {
                            actionButtons.style.display = 'flex';
                        }
                        
                        // Store report data for view/download
                        this.currentReportData = data;
                    }, 500);
                }, 1000);
            }, 500);
        }

        handleUploadError(errorMessage) {
            alert('Upload failed: ' + errorMessage);
            const uploadSection = document.getElementById('uploadSection');
            const progressSection = document.getElementById('progressTrackerSection');
            
            if (uploadSection) uploadSection.style.display = 'block';
            if (progressSection) progressSection.style.display = 'none';
        }

        async processImage() {
            if (!this.capturedImage) {
                this.showError('No image selected.');
                return;
            }

            this.elements.resultsSection.style.display = 'block';
            this.elements.loadingIndicator.style.display = 'block';
            this.elements.extractedResults.style.display = 'none';
            this.elements.processBtn.disabled = true;
            
            // Reset and show progress bar
            if (this.elements.progressFill) {
                this.elements.progressFill.style.width = '0%';
            }

            try {
                const blob = await (await fetch(this.capturedImage)).blob();
                const formData = new FormData();
                formData.append('image', blob, 'image.jpg');

                // Use XMLHttpRequest for progress tracking
                const xhr = new XMLHttpRequest();
                
                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable && this.elements.progressFill) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        this.elements.progressFill.style.width = Math.min(percentComplete, 90) + '%';
                    }
                });

                // Track download progress
                xhr.addEventListener('progress', (e) => {
                    if (e.lengthComputable && this.elements.progressFill) {
                        const uploadPercent = 90;
                        const downloadPercent = (e.loaded / e.total) * 10;
                        this.elements.progressFill.style.width = (uploadPercent + downloadPercent) + '%';
                    }
                });

                const result = await new Promise((resolve, reject) => {
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                if (result.error) {
                                    reject(new Error(result.error));
                                } else {
                                    // Complete progress
                                    if (this.elements.progressFill) {
                                        this.elements.progressFill.style.width = '100%';
                                    }
                                    resolve(result);
                                }
                            } catch (e) {
                                reject(new Error('Failed to parse response: ' + e.message));
                            }
                        } else {
                            reject(new Error(`Upload failed: ${xhr.statusText}`));
                        }
                    };
                    
                    xhr.onerror = () => {
                        reject(new Error('Network error occurred'));
                    };
                    
                    xhr.open('POST', '/upload_image');
                    xhr.send(formData);
                });

                // inside processImage() after getting result
                this.displayResults(result.text, 80);
                if (result.summary) {
                    this.displaySummary(result.summary);
                }

            } catch (error) {
                this.showError(error.message);
            } finally {
                this.elements.loadingIndicator.style.display = 'none';
                this.elements.processBtn.disabled = false;
            }
        }

        displayResults(text, confidence) {
            this.elements.loadingIndicator.style.display = 'none';
            this.elements.extractedResults.style.display = 'block';

            const cleanedText = text.trim() || 'No text extracted.';
            this.elements.extractedText.textContent = cleanedText;

            const confidencePercentage = Math.round(confidence);
            const color = confidencePercentage > 70 ? '#27ae60' :
                        confidencePercentage > 50 ? '#f39c12' : '#e74c3c';

            this.elements.confidenceScore.textContent = `Confidence: ${confidencePercentage}%`;
            this.elements.confidenceScore.style.background = `linear-gradient(135deg, ${color}, ${color}dd)`;
        }

        displayEntities(entities) {
    const container = document.createElement('div');
    container.innerHTML = '<h4>üß¨ NLP Extracted Medical Info:</h4>';
    container.style.marginTop = '20px';

    if (!entities || entities.length === 0) {
        const none = document.createElement('p');
        none.textContent = 'No medical entities detected.';
        container.appendChild(none);
        this.elements.extractedResults.appendChild(container);
        return;
    }

    const grouped = {};

    entities.forEach(ent => {
        const type = ent.Type.toUpperCase();
        if (!grouped[type]) grouped[type] = new Set();
        grouped[type].add(ent.Text);
    });

    const typeLabels = {
        PROTECTED_HEALTH_INFORMATION: "üë§ Patient Information",
        ANATOMY: "üßç‚Äç‚ôÇÔ∏è Anatomical Areas",
        MEDICAL_CONDITION: "ü©∫ Medical Conditions & Symptoms",
        TIME_EXPRESSION: "üïí Timeline",
        TEST_TREATMENT_PROCEDURE: "üß™ Tests / Treatments",
        MEDICATION: "üíä Medications"
    };

    for (const [type, texts] of Object.entries(grouped)) {
        const section = document.createElement('div');
        section.className = "entity-group";

        const label = document.createElement('div');
        label.className = "entity-type";
        label.textContent = typeLabels[type] || type;

        const values = document.createElement('div');
        values.className = "entity-values";
        values.textContent = Array.from(texts).join(', ');

        section.appendChild(label);
        section.appendChild(values);
        container.appendChild(section);
    }

    this.elements.extractedResults.appendChild(container);
}
        

        displaySummary(summary) {
    const box = document.createElement('div');
    box.className = 'results-box';
    box.innerHTML = `
    <div class="entity-group">
        <div class="entity-type">üë§ Patient Information</div>
        <div class="entity-values">
            ${summary["Patient Information"].Name ? `Name: ${summary["Patient Information"].Name}<br>` : ''}
            ${summary["Patient Information"]["Age/Gender"] ? `Age/Gender: ${summary["Patient Information"]["Age/Gender"]}<br>` : ''}
            ${summary["Patient Information"].Doctor ? `Doctor: ${summary["Patient Information"].Doctor}<br>` : ''}
            ${summary["Patient Information"]["Hospital/Clinic"] ? `Hospital: ${summary["Patient Information"]["Hospital/Clinic"]}<br>` : ''}
            ${summary["Patient Information"].Date ? `Date: ${summary["Patient Information"].Date}<br>` : ''}
        </div>
      </div>

      <div class="entity-group">
        <div class="entity-type">ü©∫ Medical Conditions</div>
        <div class="entity-values">
          ${(summary["Medical Conditions"] || []).join('<br>') || '‚Äî'}
        </div>
      </div>

      <div class="entity-group">
        <div class="entity-type">üíä Medications</div>
        <div class="entity-values">
          ${(summary["Medications"] || []).map(m => {
            const parts = [m.name];
            if (m.purpose) parts.push(m.purpose);
            if (m.generic) parts.push(`(${m.generic})`);
            return parts.join(' ');
          }).join('<br>') || '‚Äî'}
        </div>
      </div>

      <div class="entity-group">
        <div class="entity-type">üß™ Tests / Procedures</div>
        <div class="entity-values">
          ${(summary["Tests / Procedures"] || []).join('<br>') || '‚Äî'}
        </div>
      </div>

      <div class="entity-group">
        <div class="entity-type">üë®‚Äç‚öïÔ∏è Suggested Specialists</div>
        <div class="entity-values">
          ${(summary["Suggested Specialists"] || []).join('<br>') || '‚Äî'}
        </div>
      </div>

    <div class="entity-group">
        <div class="entity-type">‚úÖ Recommendations</div>
        <div class="entity-values">
        <ul style="list-style-type: disc; padding-left: 20px; margin: 0;">
            ${(summary["Recommendations"] || []).map(r => `<li>${r}</li>`).join('')}
          </ul>
        </div>
      </div>
    `;
    this.elements.extractedResults.appendChild(box);
}


        resetCapture() {
            this.stopCamera();
            this.capturedImage = null;
            this.elements.previewSection.style.display = 'none';
            this.elements.resultsSection.style.display = 'none';
            this.elements.fileInput.value = '';
            this.elements.progressFill.style.width = '0%';
        }

        copyText() {
            const text = this.elements.extractedText.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const original = this.elements.copyBtn.textContent;
                this.elements.copyBtn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    this.elements.copyBtn.textContent = original;
                }, 2000);
            });
        }

        showError(message) {
            const existing = document.querySelector('.error-message');
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;

            this.elements.resultsSection.style.display = 'block';
            this.elements.resultsSection.insertBefore(div, this.elements.resultsSection.firstChild);

            setTimeout(() => div.remove(), 5000);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new PrescriptionReader();
    });
</script>
</body>
</html>